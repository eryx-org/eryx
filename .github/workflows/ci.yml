name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Detect which paths changed to skip unnecessary jobs.
  # Each downstream job has an explicit 'github.event_name == push' override
  # so that all jobs always run on pushes to main.
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      core: ${{ steps.filter.outputs.core }}
      python: ${{ steps.filter.outputs.python }}
      book: ${{ steps.filter.outputs.book }}
      examples: ${{ steps.filter.outputs.examples }}
      js: ${{ steps.filter.outputs.js }}
      demo: ${{ steps.filter.outputs.demo }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            core:
              - 'crates/eryx-core/**'
              - 'crates/eryx/**'
              - 'crates/eryx-wasm-runtime/**'
              - 'crates/eryx-runtime/**'
              - 'crates/eryx-precompile/**'
              - 'Cargo.lock'
              - 'Cargo.toml'
              - '.github/workflows/ci.yml'
              - '.github/actions/**'
            python:
              - 'crates/eryx-python/**'
            book:
              - 'book/**'
            examples:
              - 'examples/**'
            js:
              - 'js/**'
            demo:
              - 'demo/**'

  # Fast check for dependency drift - runs in parallel with build
  unify-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    needs: changes
    if: >-
      github.event_name == 'push'
      || needs.changes.outputs.core == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-rust

      - name: Check dependency unification
        run: cargo rail unify --check

  # Build eryx-wasm-runtime and precompile it - other jobs depend on this.
  # Runs when core paths change, or when any downstream job needs WASM artifacts.
  build-eryx-runtime:
    name: Build eryx-runtime
    runs-on: namespace-profile-eryx-heavy-linux-amd64
    needs: changes
    if: >-
      github.event_name == 'push'
      || needs.changes.outputs.core == 'true'
      || needs.changes.outputs.python == 'true'
      || needs.changes.outputs.book == 'true'
      || needs.changes.outputs.examples == 'true'
      || needs.changes.outputs.js == 'true'
      || needs.changes.outputs.demo == 'true'
    steps:
      - uses: namespacelabs/nscloud-checkout-action@v8

      - name: Cache WASM runtime artifacts
        id: wasm-cache
        uses: actions/cache@v4
        with:
          path: |
            crates/eryx-runtime/runtime.wasm
            crates/eryx-runtime/runtime.cwasm
            crates/eryx-runtime/prebuilt/
            crates/eryx-wasm-runtime/target/liberyx_runtime.so
          key: wasm-runtime-v2-${{ hashFiles('crates/eryx-wasm-runtime/src/**', 'crates/eryx-wasm-runtime/clock_stubs.c', 'crates/eryx-wasm-runtime/Cargo.toml', 'crates/eryx-runtime/build.rs', 'crates/eryx-runtime/wit/runtime.wit', 'crates/eryx-runtime/libs/*.zst', 'Cargo.lock') }}

      - name: Touch cached artifacts
        if: steps.wasm-cache.outputs.cache-hit == 'true'
        run: |
          # Touch all cached files so mise/make consider them current
          touch crates/eryx-runtime/runtime.wasm
          touch crates/eryx-runtime/runtime.cwasm
          touch crates/eryx-runtime/prebuilt/*
          touch crates/eryx-wasm-runtime/target/liberyx_runtime.so

      - name: Upload WASM artifacts (cache hit)
        if: steps.wasm-cache.outputs.cache-hit == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: wasm-runtime
          path: |
            crates/eryx-runtime/runtime.wasm
            crates/eryx-runtime/runtime.cwasm
            crates/eryx-runtime/prebuilt/
            crates/eryx-wasm-runtime/target/liberyx_runtime.so
          retention-days: 1

      - name: Configure Rust cache
        if: steps.wasm-cache.outputs.cache-hit != 'true'
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: rust

      - uses: ./.github/actions/setup-rust
        if: steps.wasm-cache.outputs.cache-hit != 'true'

      - name: Install nightly toolchain
        if: steps.wasm-cache.outputs.cache-hit != 'true'
        run: rustup toolchain install nightly-2026-01-31 --component rust-src

      - name: Force rebuild (cache may have stale timestamps)
        if: steps.wasm-cache.outputs.cache-hit != 'true'
        run: |
          # Touch ALL sources to ensure mise doesn't skip build due to cached timestamps
          # The Rust cache may restore .rlib files with newer timestamps than sources
          find crates/eryx-wasm-runtime/src -name "*.rs" -exec touch {} +
          touch crates/eryx-wasm-runtime/clock_stubs.c
          touch crates/eryx-wasm-runtime/Cargo.toml
          # Remove outputs (mise checks mtime, not existence)
          rm -f crates/eryx-runtime/runtime.wasm crates/eryx-runtime/runtime.cwasm

      - name: Build eryx-runtime
        if: steps.wasm-cache.outputs.cache-hit != 'true'
        run: mise run build-eryx-runtime

      - name: Copy prebuilt late-linking artifacts
        if: steps.wasm-cache.outputs.cache-hit != 'true'
        run: |
          # Find the OUT_DIR that actually contains the built artifacts
          # (not just any OUT_DIR - the preinit build creates a new one without .so files)
          OUT_DIR=$(find target/release -path "*/eryx-runtime-*/out/liberyx_runtime.so" -type f | head -1 | xargs dirname)
          echo "Found OUT_DIR: $OUT_DIR"
          mkdir -p crates/eryx-runtime/prebuilt
          cp "$OUT_DIR/liberyx_runtime.so.zst" crates/eryx-runtime/prebuilt/
          cp "$OUT_DIR/liberyx_bindings.so.zst" crates/eryx-runtime/prebuilt/
          # Also copy liberyx_runtime.so for eryx-wasm-runtime tests now, before preinit build
          mkdir -p crates/eryx-wasm-runtime/target
          cp "$OUT_DIR/liberyx_runtime.so" crates/eryx-wasm-runtime/target/
          ls -la crates/eryx-runtime/prebuilt/
          ls -la crates/eryx-wasm-runtime/target/

      - name: Set up python-stdlib for preinit
        if: steps.wasm-cache.outputs.cache-hit != 'true'
        run: mise run setup-eryx-runtime-tests

      - name: Precompile WASM with preinit
        if: steps.wasm-cache.outputs.cache-hit != 'true'
        run: |
          # Use preinit feature for faster sandbox instantiation in downstream jobs
          # (pre-initializes Python interpreter in the snapshot)
          cargo run -p eryx --example precompile --features preinit --release
        env:
          ERYX_PRECOMPILE_BOOTSTRAP: "1"
          # Use x86-64-v2 for portable cwasm across runner types (Namespace has AVX-512,
          # but downstream jobs on ubuntu-latest do not)
          ERYX_CPU_FEATURES: "x86-64-v2"

      - name: Upload WASM artifacts (cache miss)
        if: steps.wasm-cache.outputs.cache-hit != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: wasm-runtime
          path: |
            crates/eryx-runtime/runtime.wasm
            crates/eryx-runtime/runtime.cwasm
            crates/eryx-runtime/prebuilt/
            crates/eryx-wasm-runtime/target/liberyx_runtime.so
          retention-days: 1

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: [changes, build-eryx-runtime]
    if: >-
      github.event_name == 'push'
      || needs.changes.outputs.core == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: crates/

      - uses: ./.github/actions/mark-wasm-current

      - name: Configure Rust cache
        uses: Swatinem/rust-cache@v2

      - uses: ./.github/actions/setup-rust

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        # Use --all-features now that prebuilt artifacts are available
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  test:
    name: Test
    runs-on: namespace-profile-eryx-heavy-linux-amd64
    needs: [changes, build-eryx-runtime]
    if: >-
      github.event_name == 'push'
      || needs.changes.outputs.core == 'true'
    steps:
      - uses: namespacelabs/nscloud-checkout-action@v8

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: crates/

      - uses: ./.github/actions/mark-wasm-current

      - name: Set up eryx-wasm-runtime test artifacts
        run: |
          # Extract python stdlib for eryx-wasm-runtime tests (from checked-in archive)
          mkdir -p crates/eryx-wasm-runtime/tests/python-stdlib
          tar -xf crates/eryx/python-stdlib.tar.zst -C crates/eryx-wasm-runtime/tests/
          # Create empty site-packages directory (tests expect it)
          mkdir -p crates/eryx-wasm-runtime/tests/site-packages
          ls -la crates/eryx-wasm-runtime/target/
          ls crates/eryx-wasm-runtime/tests/python-stdlib/ | head -10

      - name: Install mold linker and clang
        run: |
          sudo apt-get update
          sudo apt-get install -y mold clang

      - name: Configure mold linker
        run: |
          mkdir -p .cargo
          cat >> .cargo/config.toml << 'EOF'
          [target.x86_64-unknown-linux-gnu]
          linker = "clang"
          rustflags = ["-C", "link-arg=-fuse-ld=mold"]
          EOF

      - name: Configure Rust cache
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: rust

      - uses: ./.github/actions/setup-rust

      - name: Run tests
        # Use --all-features to test everything. This works because:
        # - runtime.wasm and runtime.cwasm are provided by artifacts
        # - prebuilt/liberyx_*.so.zst are provided for late-linking feature
        # - liberyx_runtime.so and python-stdlib are provided for eryx-wasm-runtime tests
        # Use --profile ci for longer timeouts on slow WASM component tests
        run: cargo nextest run --workspace --all-features --profile ci

  msrv:
    name: MSRV
    runs-on: ubuntu-latest
    needs: changes
    if: >-
      github.event_name == 'push'
      || needs.changes.outputs.core == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Configure Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install mise
        uses: jdx/mise-action@v3
        with:
          mise_toml: |
            [tools]
            rust = "1.90"

      - name: Check MSRV
        # Exclude eryx-python and eryx-precompile as they require building eryx-runtime
        # which needs WASI SDK (not installed in MSRV check)
        run: cargo check --workspace --exclude eryx-python --exclude eryx-precompile

  doc:
    name: Documentation
    runs-on: ubuntu-latest
    needs: [changes, build-eryx-runtime]
    if: >-
      github.event_name == 'push'
      || needs.changes.outputs.core == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: crates/

      - uses: ./.github/actions/mark-wasm-current

      - name: Configure Rust cache
        uses: Swatinem/rust-cache@v2

      - uses: ./.github/actions/setup-rust

      - name: Build documentation
        # Use --all-features now that prebuilt artifacts are available
        run: cargo doc --workspace --no-deps --all-features
        env:
          RUSTDOCFLAGS: -D warnings

  # Check that all feature combinations compile
  check-features:
    name: Check Feature Combinations
    runs-on: ubuntu-latest
    needs: [changes, build-eryx-runtime]
    if: >-
      github.event_name == 'push'
      || needs.changes.outputs.core == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: crates/

      - uses: ./.github/actions/mark-wasm-current

      - name: Configure Rust cache
        uses: Swatinem/rust-cache@v2

      - uses: ./.github/actions/setup-rust

      - name: Check all feature combinations
        # cargo-all-features checks the powerset of feature combinations.
        # The Cargo.toml config skips preinit/native-extensions for local dev (no artifacts),
        # but in CI we have artifacts, so we check those separately.
        run: |
          echo "=== Checking feature powerset (excluding preinit/native-extensions) ==="
          cargo check-all-features -- -p eryx

          echo "=== Checking features that require runtime artifacts ==="
          cargo check -p eryx --features preinit
          cargo check -p eryx --features embedded,preinit
          cargo check -p eryx --features native-extensions
          cargo check -p eryx --features embedded,native-extensions

  # Run examples to ensure they don't bitrot
  examples:
    name: Examples
    runs-on: ubuntu-latest
    needs: [changes, build-eryx-runtime]
    if: >-
      github.event_name == 'push'
      || needs.changes.outputs.core == 'true'
      || needs.changes.outputs.examples == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: crates/

      - uses: ./.github/actions/mark-wasm-current

      - name: Configure Rust cache
        uses: Swatinem/rust-cache@v2

      - uses: ./.github/actions/setup-rust

      - name: Run examples
        run: |
          echo "=== simple ==="
          cargo run --package eryx --example simple --features embedded --release
          echo "=== parallel_callbacks ==="
          cargo run --package eryx --example parallel_callbacks --features embedded --release
          echo "=== with_tracing ==="
          cargo run --package eryx --example with_tracing --features embedded --release
          echo "=== error_handling ==="
          cargo run --package eryx --example error_handling --features embedded --release
          echo "=== resource_limits ==="
          cargo run --package eryx --example resource_limits --features embedded --release
          echo "=== custom_library ==="
          cargo run --package eryx --example custom_library --features embedded --release
          echo "=== session_reuse ==="
          cargo run --package eryx --example session_reuse --features embedded --release
          echo "=== runtime_callbacks ==="
          cargo run --package eryx --example runtime_callbacks --features embedded --release
          echo "=== precompile ==="
          cargo run --package eryx --example precompile --features embedded --release
          echo "=== embedded_runtime ==="
          cargo run --package eryx --example embedded_runtime --features embedded --release
          echo "=== trace_events ==="
          cargo run --package eryx --example trace_events --features embedded --release

  # Test Python bindings
  python-bindings:
    name: Python Bindings
    runs-on: ubuntu-latest
    needs: [changes, build-eryx-runtime]
    if: >-
      github.event_name == 'push'
      || needs.changes.outputs.core == 'true'
      || needs.changes.outputs.python == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: crates/

      - uses: ./.github/actions/mark-wasm-current

      - name: Configure Rust cache
        uses: Swatinem/rust-cache@v2

      - uses: ./.github/actions/setup-rust

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Build and install eryx-python with dev dependencies
        working-directory: crates/eryx-python
        run: |
          uv venv ../../.venv
          source ../../.venv/bin/activate
          uv pip install maturin
          maturin develop --release
          uv pip install -e '.[dev]'

      - name: Run Python tests
        working-directory: crates/eryx-python
        run: |
          source ../../.venv/bin/activate
          pytest tests/ -v

      - name: Run Python examples
        working-directory: crates/eryx-python
        run: |
          source ../../.venv/bin/activate
          echo "=== simple.py ==="
          python examples/simple.py
          echo "=== error_handling.py ==="
          python examples/error_handling.py
          echo "=== resource_limits.py ==="
          python examples/resource_limits.py

  # Test book examples
  book-tests:
    name: Book Tests
    runs-on: ubuntu-latest
    needs: [changes, build-eryx-runtime]
    if: >-
      github.event_name == 'push'
      || needs.changes.outputs.core == 'true'
      || needs.changes.outputs.book == 'true'
      || needs.changes.outputs.python == 'true'
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      - uses: actions/checkout@v4

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: crates/

      - uses: ./.github/actions/mark-wasm-current

      - name: Configure Rust cache
        uses: Swatinem/rust-cache@v2

      - uses: ./.github/actions/setup-rust

      - name: Install mdbook tools
        run: |
          cargo binstall -y mdbook
          cargo binstall -y mdbook-langtabs

      - name: Build project
        run: |
          # Clean eryx packages to avoid "multiple rmeta candidates" from cached
          # feature combinations (e.g., from check-all-features job)
          cargo clean -p eryx -p eryx-runtime 2>/dev/null || true
          cargo build -p eryx --features embedded,macros

      - name: Test Rust code blocks
        run: mdbook test -L ../target/debug/deps
        working-directory: book

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Create virtualenv and install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install maturin pytest

      - name: Build and install eryx-python
        working-directory: crates/eryx-python
        run: |
          source ../../.venv/bin/activate
          maturin develop --release

      - name: Test Python code blocks
        working-directory: book
        run: |
          source ../.venv/bin/activate
          python scripts/test_examples.py

  # Deploy book to GitHub Pages (only on main)
  deploy-book:
    name: Deploy Book
    runs-on: ubuntu-latest
    needs: book-tests
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for version detection

      - name: Install cargo-binstall
        run: curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash

      - name: Install mdbook tools
        run: |
          cargo binstall -y mdbook
          cargo binstall -y mdbook-langtabs

      - name: Detect version
        id: version
        run: |
          VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "version=v$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: v$VERSION"

      - name: Build book
        working-directory: book
        run: mdbook build

      - name: Prepare deployment directory
        run: |
          mkdir -p deploy/latest/book
          mkdir -p deploy/${{ steps.version.outputs.version }}/book
          cp -r book/book/* deploy/latest/book/
          cp -r book/book/* deploy/${{ steps.version.outputs.version }}/book/
          echo "docs.eryx.run" > deploy/CNAME
          cat > deploy/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Eryx Documentation</title>
            <meta http-equiv="refresh" content="0; url=latest/book/">
          </head>
          <body>
            <p>Redirecting to <a href="latest/book/">latest documentation</a>...</p>
          </body>
          </html>
          HTMLEOF

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: 'deploy'

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

  # Deploy browser demo to Cloudflare Pages.
  # - On main: production deployment (custom domain)
  # - On PRs: preview deployment (<branch>.eryx-demo.pages.dev)
  deploy-demo:
    name: Deploy Demo
    runs-on: ubuntu-latest
    needs: [changes, build-eryx-runtime]
    if: >-
      github.event.pull_request.head.repo.fork != true
      && (github.event_name == 'push'
      || needs.changes.outputs.core == 'true'
      || needs.changes.outputs.js == 'true'
      || needs.changes.outputs.demo == 'true')
    permissions:
      contents: read
      deployments: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: crates/

      - uses: ./.github/actions/mark-wasm-current

      - name: Configure Rust cache
        uses: Swatinem/rust-cache@v2

      - uses: ./.github/actions/setup-rust

      - name: Build JavaScript bindings
        working-directory: js
        run: mise run build

      - name: Install eryx dependencies
        run: npm ci --prefix js/eryx

      - name: Build demo site
        working-directory: js/demo
        run: |
          npm install
          npx vite build

      - name: Deploy to Cloudflare Pages
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy js/demo/dist --project-name=eryx-demo --branch=${{ github.head_ref || github.ref_name }} --commit-dirty=true

      - name: Comment preview URL on PR
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BODY="üåê **Demo preview:** ${{ steps.deploy.outputs.pages-deployment-alias-url }}
          üìå **This deploy:** ${{ steps.deploy.outputs.deployment-url }}"
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "$BODY" --edit-last || \
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "$BODY"
