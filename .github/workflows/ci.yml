name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Fast check for dependency drift - runs in parallel with build
  unify-check:
    name: Dependency Check
    runs-on: namespace-profile-eryx-light
    steps:
      - uses: namespacelabs/nscloud-checkout-action@v8

      - uses: ./.github/actions/setup-rust

      - name: Check dependency unification
        run: cargo rail unify --check

  # Test base functionality without any features (needs runtime.wasm for sandbox tests)
  test-base:
    name: Test (no features)
    runs-on: namespace-profile-eryx-light
    needs: build-eryx-runtime
    steps:
      - uses: namespacelabs/nscloud-checkout-action@v8

      - name: Download WASM artifacts
        uses: namespace-actions/download-artifact@v1
        with:
          name: wasm-runtime
          path: crates/

      - name: Mark WASM as up-to-date
        run: touch crates/eryx-runtime/runtime.wasm crates/eryx-runtime/runtime.cwasm

      - name: Extract Python stdlib
        run: |
          # Archive has python-stdlib/ prefix, so extract to temp then move contents
          mkdir -p python-stdlib-tmp
          tar -xf crates/eryx/python-stdlib.tar.zst -C python-stdlib-tmp
          mv python-stdlib-tmp/python-stdlib python-stdlib
          rm -rf python-stdlib-tmp
          echo "ERYX_PYTHON_STDLIB=$PWD/python-stdlib" >> $GITHUB_ENV

      - name: Configure Rust cache
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: rust

      - uses: ./.github/actions/setup-rust

      - name: Run tests without features
        run: cargo nextest run --workspace --no-default-features

  # Build eryx-wasm-runtime and precompile it - other jobs depend on this
  build-eryx-runtime:
    name: Build eryx-runtime
    runs-on: namespace-profile-eryx-heavy
    steps:
      - uses: namespacelabs/nscloud-checkout-action@v8

      - name: Configure Rust cache
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: rust

      - uses: ./.github/actions/setup-rust

      - name: Install nightly toolchain
        run: rustup toolchain install nightly --component rust-src

      - name: Force rebuild (cache may have stale timestamps)
        run: |
          # Touch sources to ensure mise doesn't skip build due to cached timestamps
          touch crates/eryx-wasm-runtime/src/lib.rs
          # Remove outputs if they don't exist (mise checks mtime, not existence)
          rm -f crates/eryx-runtime/runtime.wasm crates/eryx-runtime/runtime.cwasm

      - name: Build eryx-runtime
        run: mise run build-eryx-runtime

      - name: Precompile WASM
        run: |
          # Run precompile directly with -p eryx to avoid building eryx-python
          # (eryx-python enables embedded feature which requires runtime.cwasm to exist)
          cargo run -p eryx --example precompile --release

      - name: Copy prebuilt late-linking artifacts
        run: |
          # Find the OUT_DIR with the compressed artifacts from the release build
          OUT_DIR=$(find target/release -path "*/eryx-runtime-*/out" -type d | head -1)
          echo "Found OUT_DIR: $OUT_DIR"
          mkdir -p crates/eryx-runtime/prebuilt
          cp "$OUT_DIR/liberyx_runtime.so.zst" crates/eryx-runtime/prebuilt/
          cp "$OUT_DIR/liberyx_bindings.so.zst" crates/eryx-runtime/prebuilt/
          ls -la crates/eryx-runtime/prebuilt/

      - name: Copy eryx-wasm-runtime test artifacts
        run: |
          # Copy liberyx_runtime.so for eryx-wasm-runtime tests (from release build)
          OUT_DIR=$(find target/release -path "*/eryx-runtime-*/out" -type d | head -1)
          mkdir -p crates/eryx-wasm-runtime/target
          cp "$OUT_DIR/liberyx_runtime.so" crates/eryx-wasm-runtime/target/
          ls -la crates/eryx-wasm-runtime/target/

      - name: Upload WASM artifacts
        uses: namespace-actions/upload-artifact@v1
        with:
          name: wasm-runtime
          path: |
            crates/eryx-runtime/runtime.wasm
            crates/eryx-runtime/runtime.cwasm
            crates/eryx-runtime/prebuilt/
            crates/eryx-wasm-runtime/target/liberyx_runtime.so
          retention-days: 1

  lint:
    name: Lint
    runs-on: namespace-profile-eryx-standard
    needs: build-eryx-runtime
    steps:
      - uses: namespacelabs/nscloud-checkout-action@v8

      - name: Download WASM artifacts
        uses: namespace-actions/download-artifact@v1
        with:
          name: wasm-runtime
          path: crates/

      # Touch artifacts to be newer than sources so mise skips rebuild
      - name: Mark WASM as up-to-date
        run: |
          touch crates/eryx-runtime/runtime.wasm crates/eryx-runtime/runtime.cwasm
          if [ -d crates/eryx-runtime/prebuilt ]; then
            touch crates/eryx-runtime/prebuilt/*
          fi

      - name: Configure Rust cache
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: rust

      - uses: ./.github/actions/setup-rust

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        # Use --all-features now that prebuilt artifacts are available
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  test:
    name: Test
    runs-on: namespace-profile-eryx-heavy
    needs: build-eryx-runtime
    steps:
      - uses: namespacelabs/nscloud-checkout-action@v8

      - name: Download WASM artifacts
        uses: namespace-actions/download-artifact@v1
        with:
          name: wasm-runtime
          path: crates/

      # Touch artifacts to be newer than sources so mise skips rebuild
      - name: Mark WASM as up-to-date
        run: |
          touch crates/eryx-runtime/runtime.wasm crates/eryx-runtime/runtime.cwasm
          # Touch prebuilt artifacts if they exist
          if [ -d crates/eryx-runtime/prebuilt ]; then
            touch crates/eryx-runtime/prebuilt/*
          fi

      - name: Set up eryx-wasm-runtime test artifacts
        run: |
          # Extract python stdlib for eryx-wasm-runtime tests (from checked-in archive)
          mkdir -p crates/eryx-wasm-runtime/tests/python-stdlib
          tar -xf crates/eryx/python-stdlib.tar.zst -C crates/eryx-wasm-runtime/tests/
          # Create empty site-packages directory (tests expect it)
          mkdir -p crates/eryx-wasm-runtime/tests/site-packages
          ls -la crates/eryx-wasm-runtime/target/
          ls crates/eryx-wasm-runtime/tests/python-stdlib/ | head -10

      - name: Install mold linker and clang
        run: |
          sudo apt-get update
          sudo apt-get install -y mold clang

      - name: Configure mold linker
        run: |
          mkdir -p .cargo
          cat >> .cargo/config.toml << 'EOF'
          [target.x86_64-unknown-linux-gnu]
          linker = "clang"
          rustflags = ["-C", "link-arg=-fuse-ld=mold"]
          EOF

      - name: Configure Rust cache
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: rust

      - uses: ./.github/actions/setup-rust

      - name: Run tests
        # Use --all-features to test everything. This works because:
        # - runtime.wasm and runtime.cwasm are provided by artifacts
        # - prebuilt/liberyx_*.so.zst are provided for late-linking feature
        # - liberyx_runtime.so and python-stdlib are provided for eryx-wasm-runtime tests
        # Use --profile ci for longer timeouts on slow WASM component tests
        run: cargo nextest run --workspace --all-features --profile ci

  msrv:
    name: MSRV
    runs-on: namespace-profile-eryx-light
    steps:
      - uses: namespacelabs/nscloud-checkout-action@v8

      - name: Configure Rust cache
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: rust

      - name: Install mise
        uses: jdx/mise-action@v3
        with:
          mise_toml: |
            [tools]
            rust = "1.89"

      - name: Check MSRV
        # Exclude eryx-python as it requires native-extensions which needs WASI SDK
        run: cargo check --workspace --exclude eryx-python

  doc:
    name: Documentation
    runs-on: namespace-profile-eryx-standard
    needs: build-eryx-runtime
    steps:
      - uses: namespacelabs/nscloud-checkout-action@v8

      - name: Download WASM artifacts
        uses: namespace-actions/download-artifact@v1
        with:
          name: wasm-runtime
          path: crates/

      # Touch artifacts to be newer than sources so mise skips rebuild
      - name: Mark WASM as up-to-date
        run: |
          touch crates/eryx-runtime/runtime.wasm crates/eryx-runtime/runtime.cwasm
          if [ -d crates/eryx-runtime/prebuilt ]; then
            touch crates/eryx-runtime/prebuilt/*
          fi

      - name: Configure Rust cache
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: rust

      - uses: ./.github/actions/setup-rust

      - name: Build documentation
        # Use --all-features now that prebuilt artifacts are available
        run: cargo doc --workspace --no-deps --all-features
        env:
          RUSTDOCFLAGS: -D warnings

  # Check that all feature combinations compile
  check-features:
    name: Check Feature Combinations
    runs-on: namespace-profile-eryx-standard
    needs: build-eryx-runtime
    steps:
      - uses: namespacelabs/nscloud-checkout-action@v8

      - name: Download WASM artifacts
        uses: namespace-actions/download-artifact@v1
        with:
          name: wasm-runtime
          path: crates/

      - name: Mark WASM as up-to-date
        run: |
          touch crates/eryx-runtime/runtime.wasm crates/eryx-runtime/runtime.cwasm
          if [ -d crates/eryx-runtime/prebuilt ]; then
            touch crates/eryx-runtime/prebuilt/*
          fi

      - name: Configure Rust cache
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: rust

      - uses: ./.github/actions/setup-rust

      - name: Check all feature combinations
        # cargo-all-features checks the powerset of feature combinations.
        # The Cargo.toml config skips preinit/native-extensions for local dev (no artifacts),
        # but in CI we have artifacts, so we check those separately.
        run: |
          echo "=== Checking feature powerset (excluding preinit/native-extensions) ==="
          cargo check-all-features -- -p eryx

          echo "=== Checking features that require runtime artifacts ==="
          cargo check -p eryx --features preinit
          cargo check -p eryx --features embedded,preinit
          cargo check -p eryx --features native-extensions
          cargo check -p eryx --features embedded,native-extensions

  # Run examples to ensure they don't bitrot
  examples:
    name: Examples
    runs-on: namespace-profile-eryx-standard
    needs: build-eryx-runtime
    steps:
      - uses: namespacelabs/nscloud-checkout-action@v8

      - name: Download WASM artifacts
        uses: namespace-actions/download-artifact@v1
        with:
          name: wasm-runtime
          path: crates/

      - name: Mark WASM as up-to-date
        run: |
          touch crates/eryx-runtime/runtime.wasm crates/eryx-runtime/runtime.cwasm
          if [ -d crates/eryx-runtime/prebuilt ]; then
            touch crates/eryx-runtime/prebuilt/*
          fi

      - name: Configure Rust cache
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: rust

      - uses: ./.github/actions/setup-rust

      - name: Run examples
        run: |
          echo "=== simple ==="
          cargo run --package eryx --example simple --features embedded --release
          echo "=== parallel_callbacks ==="
          cargo run --package eryx --example parallel_callbacks --features embedded --release
          echo "=== with_tracing ==="
          cargo run --package eryx --example with_tracing --features embedded --release
          echo "=== error_handling ==="
          cargo run --package eryx --example error_handling --features embedded --release
          echo "=== resource_limits ==="
          cargo run --package eryx --example resource_limits --features embedded --release
          echo "=== custom_library ==="
          cargo run --package eryx --example custom_library --features embedded --release
          echo "=== session_reuse ==="
          cargo run --package eryx --example session_reuse --features embedded --release
          echo "=== runtime_callbacks ==="
          cargo run --package eryx --example runtime_callbacks --features embedded --release
          echo "=== precompile ==="
          cargo run --package eryx --example precompile --features embedded --release
          echo "=== embedded_runtime ==="
          cargo run --package eryx --example embedded_runtime --features embedded --release
          echo "=== trace_events ==="
          cargo run --package eryx --example trace_events --features embedded --release

  # Test Python bindings
  python-bindings:
    name: Python Bindings
    runs-on: namespace-profile-eryx-standard
    needs: build-eryx-runtime
    steps:
      - uses: namespacelabs/nscloud-checkout-action@v8

      - name: Download WASM artifacts
        uses: namespace-actions/download-artifact@v1
        with:
          name: wasm-runtime
          path: crates/

      - name: Mark WASM as up-to-date
        run: |
          touch crates/eryx-runtime/runtime.wasm crates/eryx-runtime/runtime.cwasm
          if [ -d crates/eryx-runtime/prebuilt ]; then
            touch crates/eryx-runtime/prebuilt/*
          fi

      - name: Configure Rust cache
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: rust

      - uses: ./.github/actions/setup-rust

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Create virtualenv and install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install maturin pytest

      - name: Build and install eryx-python
        working-directory: crates/eryx-python
        run: |
          source ../../.venv/bin/activate
          maturin develop --release

      - name: Run Python tests
        working-directory: crates/eryx-python
        run: |
          source ../../.venv/bin/activate
          pytest tests/ -v

      - name: Run Python examples
        working-directory: crates/eryx-python
        run: |
          source ../../.venv/bin/activate
          echo "=== simple.py ==="
          python examples/simple.py
          echo "=== error_handling.py ==="
          python examples/error_handling.py
          echo "=== resource_limits.py ==="
          python examples/resource_limits.py
