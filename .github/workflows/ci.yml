name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Build WASM runtime and precompile it - other jobs depend on this
  build-wasm:
    name: Build WASM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Cache Rust toolchain and cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.rustup/toolchains
            ~/.rustup/update-hashes
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-rust-wasm-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-wasm-

      - uses: ./.github/actions/setup-rust

      - name: Install nightly toolchain
        run: rustup toolchain install nightly --component rust-src

      - name: Build WASM runtime
        run: mise run build-wasm

      - name: Precompile WASM
        run: mise run precompile-wasm

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-runtime
          path: |
            crates/eryx-runtime/runtime.wasm
            crates/eryx-runtime/runtime.cwasm
          retention-days: 1

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: build-wasm
    steps:
      - uses: actions/checkout@v6

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: crates/eryx-runtime/

      # Touch artifacts to be newer than sources so mise skips rebuild
      - name: Mark WASM as up-to-date
        run: touch crates/eryx-runtime/runtime.wasm crates/eryx-runtime/runtime.cwasm

      - name: Cache Rust toolchain and cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.rustup/toolchains
            ~/.rustup/update-hashes
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-rust-lint-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-lint-

      - uses: ./.github/actions/setup-rust

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build-wasm
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          df -h

      - uses: actions/checkout@v6

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: crates/eryx-runtime/

      # Touch artifacts to be newer than sources so mise skips rebuild
      - name: Mark WASM as up-to-date
        run: touch crates/eryx-runtime/runtime.wasm crates/eryx-runtime/runtime.cwasm

      - name: Install mold linker
        run: |
          sudo apt-get update
          sudo apt-get install -y mold

      - name: Configure mold linker
        run: |
          mkdir -p .cargo
          cat >> .cargo/config.toml << 'EOF'
          [target.x86_64-unknown-linux-gnu]
          linker = "clang"
          rustflags = ["-C", "link-arg=-fuse-ld=mold"]
          EOF

      - name: Cache Rust toolchain and cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.rustup/toolchains
            ~/.rustup/update-hashes
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-rust-test-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-test-

      - uses: ./.github/actions/setup-rust

      - name: Run tests
        run: cargo nextest run --workspace --features precompiled

  msrv:
    name: MSRV
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Cache Rust toolchain and cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.rustup/toolchains
            ~/.rustup/update-hashes
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-rust-msrv-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-msrv-

      - name: Install mise
        uses: jdx/mise-action@v3
        with:
          mise_toml: |
            [tools]
            rust = "1.89"

      - name: Check MSRV
        run: cargo check --workspace

  doc:
    name: Documentation
    runs-on: ubuntu-latest
    needs: build-wasm
    steps:
      - uses: actions/checkout@v6

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: crates/eryx-runtime/

      # Touch artifacts to be newer than sources so mise skips rebuild
      - name: Mark WASM as up-to-date
        run: touch crates/eryx-runtime/runtime.wasm crates/eryx-runtime/runtime.cwasm

      - name: Cache Rust toolchain and cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.rustup/toolchains
            ~/.rustup/update-hashes
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-rust-doc-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-doc-

      - uses: ./.github/actions/setup-rust

      - name: Build documentation
        run: cargo doc --workspace --no-deps --all-features
        env:
          RUSTDOCFLAGS: -D warnings
