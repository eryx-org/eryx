# JavaScript package release workflow for @bsull/eryx
#
# This workflow builds, tests, and publishes the npm package.
# It runs on:
# - GitHub Release published (filtered to eryx-v* tags, triggered by release-plz)
# - Manual workflow dispatch
#
# npm provenance is provided via OIDC - no NPM_TOKEN secret needed.
# Configure "trusted publishers" on npmjs.com for this repo.

name: JS Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      publish:
        description: "Publish to npm"
        required: false
        default: false
        type: boolean

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  build-and-test:
    name: Build & Test
    runs-on: namespace-profile-eryx-heavy-linux-amd64
    # Only run for the main eryx crate release (not eryx-macros, eryx-vfs, etc.)
    if: >-
      github.event_name == 'workflow_dispatch' ||
      startsWith(github.event.release.tag_name, 'eryx-v')
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      - uses: namespacelabs/nscloud-checkout-action@v8

      - name: Cache WASM runtime artifacts
        id: wasm-cache
        uses: actions/cache@v4
        with:
          path: |
            crates/eryx-runtime/runtime.wasm
            crates/eryx-runtime/runtime-preinit.wasm
          key: wasm-runtime-v2-${{ hashFiles('crates/eryx-wasm-runtime/src/**', 'crates/eryx-wasm-runtime/clock_stubs.c', 'crates/eryx-wasm-runtime/Cargo.toml', 'crates/eryx-runtime/build.rs', 'crates/eryx-runtime/wit/runtime.wit', 'crates/eryx-runtime/libs/*.zst', 'Cargo.lock') }}

      - name: Touch cached artifacts
        if: steps.wasm-cache.outputs.cache-hit == 'true'
        run: |
          touch crates/eryx-runtime/runtime.wasm
          touch crates/eryx-runtime/runtime-preinit.wasm

      - name: Configure Rust cache
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: rust

      - uses: ./.github/actions/setup-rust

      - name: Install nightly toolchain
        run: rustup toolchain install nightly --component rust-src

      - name: Install mise
        uses: jdx/mise-action@v3

      - name: Build and test JS bindings
        working-directory: js
        run: mise run test

      - name: Upload JS package
        uses: actions/upload-artifact@v4
        with:
          name: js-package
          path: js/eryx/
          retention-days: 5

  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.publish)
    environment: npm
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Download JS package
        uses: actions/download-artifact@v4
        with:
          name: js-package
          path: package/

      - uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Publish to npm
        working-directory: package
        run: npm publish --provenance --access public
