# Python wheel release workflow for eryx-python
#
# This workflow builds and publishes Python wheels for multiple platforms.
# It runs on:
# - Tags starting with 'py-v' (e.g., py-v0.1.0)
# - Manual workflow dispatch
#
# To release:
# 1. Update version in crates/eryx-python/Cargo.toml and pyproject.toml
# 2. git tag py-v0.1.0
# 3. git push origin py-v0.1.0

name: Python Release

on:
  push:
    tags:
      - "py-v*"
  workflow_dispatch:
    inputs:
      publish:
        description: "Publish to PyPI"
        required: false
        default: false
        type: boolean

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build the WASM runtime first - required for all wheel builds
  # This produces platform-independent artifacts only
  build-runtime:
    name: Build Runtime
    runs-on: namespace-profile-eryx-heavy-linux-amd64
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install nightly toolchain
        run: rustup toolchain install nightly --component rust-src

      - name: Install mise
        uses: jdx/mise-action@v3

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2

      - name: Build eryx-runtime
        run: mise run build-eryx-runtime

      # Extract Python stdlib for pre-initialization
      # This is needed so each platform can pre-initialize Python when precompiling
      - name: Extract Python stdlib
        run: mise run setup-eryx-runtime-tests

      # NOTE: We do NOT precompile here - each platform job will precompile
      # for its target architecture. The .cwasm file is NOT portable across
      # platforms/architectures.

      - name: Copy prebuilt late-linking artifacts
        run: |
          OUT_DIR=$(find target/release -path "*/eryx-runtime-*/out" -type d | head -1)
          mkdir -p crates/eryx-runtime/prebuilt
          cp "$OUT_DIR/liberyx_runtime.so.zst" crates/eryx-runtime/prebuilt/
          cp "$OUT_DIR/liberyx_bindings.so.zst" crates/eryx-runtime/prebuilt/

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-runtime
          path: |
            crates/eryx-runtime/runtime.wasm
            crates/eryx-runtime/prebuilt/
            crates/eryx-wasm-runtime/tests/python-stdlib/
          retention-days: 1

  # Build wheels for Linux x86_64 (native build with precompile)
  linux-x86_64:
    name: Linux (x86_64)
    runs-on: namespace-profile-eryx-heavy-linux-amd64
    needs: build-runtime
    steps:
      - uses: actions/checkout@v4

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: crates/

      - name: Verify artifacts
        run: |
          echo "=== Checking downloaded artifacts ==="
          ls -la crates/eryx-runtime/
          ls -la crates/eryx-runtime/prebuilt/ || echo "prebuilt dir missing!"

          # Verify required files exist
          test -f crates/eryx-runtime/runtime.wasm || (echo "runtime.wasm missing!" && exit 1)
          test -f crates/eryx-runtime/prebuilt/liberyx_runtime.so.zst || (echo "liberyx_runtime.so.zst missing!" && exit 1)
          test -f crates/eryx-runtime/prebuilt/liberyx_bindings.so.zst || (echo "liberyx_bindings.so.zst missing!" && exit 1)

          # Touch to mark as up-to-date
          touch crates/eryx-runtime/runtime.wasm
          touch crates/eryx-runtime/prebuilt/*

          echo "=== All artifacts verified ==="

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2

      - name: Pre-compile WASM for this platform (with Python pre-init)
        run: |
          echo "Pre-compiling WASM for Linux x86_64 with Python pre-initialization..."
          cargo run -p eryx --example precompile --features preinit --release
          ls -la crates/eryx-runtime/runtime.cwasm

      - name: Mark cwasm as up-to-date
        run: touch crates/eryx-runtime/runtime.cwasm

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: x86_64
          args: --release --out dist --manifest-path crates/eryx-python/Cargo.toml
          manylinux: auto

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-x86_64
          path: dist

      - name: Test wheel
        run: |
          python -m pip install pytest
          python -m pip install dist/*.whl --force-reinstall
          cd crates/eryx-python && pytest tests/ -v

  # Build wheels for Linux aarch64 (native ARM build with precompile)
  linux-aarch64:
    name: Linux (aarch64)
    runs-on: namespace-profile-eryx-heavy-linux-arm64
    needs: build-runtime
    steps:
      - uses: actions/checkout@v4

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: crates/

      - name: Verify artifacts
        run: |
          echo "=== Checking downloaded artifacts ==="
          ls -la crates/eryx-runtime/
          ls -la crates/eryx-runtime/prebuilt/ || echo "prebuilt dir missing!"

          # Verify required files exist
          test -f crates/eryx-runtime/runtime.wasm || (echo "runtime.wasm missing!" && exit 1)
          test -f crates/eryx-runtime/prebuilt/liberyx_runtime.so.zst || (echo "liberyx_runtime.so.zst missing!" && exit 1)
          test -f crates/eryx-runtime/prebuilt/liberyx_bindings.so.zst || (echo "liberyx_bindings.so.zst missing!" && exit 1)

          # Touch to mark as up-to-date
          touch crates/eryx-runtime/runtime.wasm
          touch crates/eryx-runtime/prebuilt/*

          echo "=== All artifacts verified ==="

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2

      - name: Pre-compile WASM for this platform (with Python pre-init)
        run: |
          echo "Pre-compiling WASM for Linux aarch64 with Python pre-initialization..."
          cargo run -p eryx --example precompile --features preinit --release
          ls -la crates/eryx-runtime/runtime.cwasm

      - name: Mark cwasm as up-to-date
        run: touch crates/eryx-runtime/runtime.cwasm

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: aarch64
          args: --release --out dist --manifest-path crates/eryx-python/Cargo.toml
          manylinux: auto

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-aarch64
          path: dist

      - name: Test wheel
        run: |
          python -m pip install pytest
          python -m pip install dist/*.whl --force-reinstall
          cd crates/eryx-python && pytest tests/ -v

  # Build wheels for macOS ARM (native build with precompile)
  macos-aarch64:
    name: macOS (aarch64)
    runs-on: namespace-profile-eryx-heavy-macos-arm64
    needs: build-runtime
    steps:
      - uses: actions/checkout@v4

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: crates/

      - name: Verify artifacts
        run: |
          echo "=== Checking downloaded artifacts ==="
          ls -la crates/eryx-runtime/
          ls -la crates/eryx-runtime/prebuilt/ || echo "prebuilt dir missing!"

          # Verify required files exist
          test -f crates/eryx-runtime/runtime.wasm || (echo "runtime.wasm missing!" && exit 1)
          test -f crates/eryx-runtime/prebuilt/liberyx_runtime.so.zst || (echo "liberyx_runtime.so.zst missing!" && exit 1)
          test -f crates/eryx-runtime/prebuilt/liberyx_bindings.so.zst || (echo "liberyx_bindings.so.zst missing!" && exit 1)

          # Touch to mark as up-to-date
          touch crates/eryx-runtime/runtime.wasm
          touch crates/eryx-runtime/prebuilt/*

          echo "=== All artifacts verified ==="

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2

      - name: Pre-compile WASM for this platform (with Python pre-init)
        run: |
          echo "Pre-compiling WASM for macOS aarch64 with Python pre-initialization..."
          cargo run -p eryx --example precompile --features preinit --release
          ls -la crates/eryx-runtime/runtime.cwasm

      - name: Mark cwasm as up-to-date
        run: touch crates/eryx-runtime/runtime.cwasm

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # The namespace macOS ARM runner has Homebrew Python at /opt/homebrew/bin/python3
      # which conflicts with actions/setup-python. We must ensure setup-python's Python
      # is found first by maturin-action.
      - name: Prepend setup-python to PATH
        run: echo "${{ env.pythonLocation }}/bin" >> $GITHUB_PATH

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: aarch64
          args: --release --out dist --manifest-path crates/eryx-python/Cargo.toml

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-aarch64
          path: dist

      # Use explicit Python path because the namespace runner's PATH includes
      # Homebrew's externally-managed Python before setup-python's Python,
      # and GITHUB_PATH modifications don't reliably propagate to all steps.
      - name: Debug Python environment
        if: always()
        run: |
          echo "=== PATH ==="
          echo "$PATH" | tr ':' '\n'
          echo "=== pythonLocation ==="
          echo "${{ env.pythonLocation }}"
          echo "=== pythonLocation/bin contents ==="
          ls -la "${{ env.pythonLocation }}/bin/" 2>/dev/null || echo "bin dir not found"
          echo "=== pythonLocation root contents ==="
          ls -la "${{ env.pythonLocation }}/" 2>/dev/null || echo "pythonLocation dir not found"
          echo "=== which python/python3 ==="
          which python python3 2>/dev/null || echo "neither found in PATH"
          echo "=== GITHUB_PATH contents ==="
          cat "$GITHUB_PATH" 2>/dev/null || echo "GITHUB_PATH file not found"

      - name: Test wheel
        run: |
          "${{ env.pythonLocation }}/bin/python3" -m pip install pytest
          "${{ env.pythonLocation }}/bin/python3" -m pip install dist/*.whl --force-reinstall
          cd crates/eryx-python && "${{ env.pythonLocation }}/bin/python3" -m pytest tests/ -v

  # Build wheels for macOS Intel (GitHub runner)
  macos-x86_64:
    name: macOS (x86_64)
    runs-on: macos-15-intel
    needs: build-runtime
    steps:
      - uses: actions/checkout@v4

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: crates/

      - name: Verify artifacts
        run: |
          echo "=== Checking downloaded artifacts ==="
          ls -la crates/eryx-runtime/
          ls -la crates/eryx-runtime/prebuilt/ || echo "prebuilt dir missing!"

          # Verify required files exist
          test -f crates/eryx-runtime/runtime.wasm || (echo "runtime.wasm missing!" && exit 1)
          test -f crates/eryx-runtime/prebuilt/liberyx_runtime.so.zst || (echo "liberyx_runtime.so.zst missing!" && exit 1)
          test -f crates/eryx-runtime/prebuilt/liberyx_bindings.so.zst || (echo "liberyx_bindings.so.zst missing!" && exit 1)

          # Touch to mark as up-to-date
          touch crates/eryx-runtime/runtime.wasm
          touch crates/eryx-runtime/prebuilt/*

          echo "=== All artifacts verified ==="

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2

      - name: Pre-compile WASM for this platform (with Python pre-init)
        run: |
          echo "Pre-compiling WASM for macOS x86_64 with Python pre-initialization..."
          cargo run -p eryx --example precompile --features preinit --release
          ls -la crates/eryx-runtime/runtime.cwasm

      - name: Mark cwasm as up-to-date
        run: touch crates/eryx-runtime/runtime.cwasm

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # The namespace macOS runner may have Homebrew Python which conflicts with
      # actions/setup-python. Prepend setup-python's bin to ensure it's found first.
      - name: Prepend setup-python to PATH
        run: echo "${{ env.pythonLocation }}/bin" >> $GITHUB_PATH

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: x86_64
          args: --release --out dist --manifest-path crates/eryx-python/Cargo.toml

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-x86_64
          path: dist

      # Use explicit Python path for consistency with aarch64 runner workaround
      - name: Test wheel
        run: |
          "${{ env.pythonLocation }}/bin/python3" -m pip install pytest
          "${{ env.pythonLocation }}/bin/python3" -m pip install dist/*.whl --force-reinstall
          cd crates/eryx-python && "${{ env.pythonLocation }}/bin/python3" -m pytest tests/ -v

  # Build wheels for Windows
  windows:
    name: Windows (${{ matrix.target }})
    runs-on: windows-latest
    needs: build-runtime
    strategy:
      fail-fast: false
      matrix:
        target:
          - x64
    steps:
      - uses: actions/checkout@v4

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: crates/

      - name: Verify artifacts
        shell: bash
        run: |
          echo "=== Checking downloaded artifacts ==="
          ls -la crates/eryx-runtime/
          ls -la crates/eryx-runtime/prebuilt/ || echo "prebuilt dir missing!"

          # Verify required files exist
          test -f crates/eryx-runtime/runtime.wasm || (echo "runtime.wasm missing!" && exit 1)
          test -f crates/eryx-runtime/prebuilt/liberyx_runtime.so.zst || (echo "liberyx_runtime.so.zst missing!" && exit 1)
          test -f crates/eryx-runtime/prebuilt/liberyx_bindings.so.zst || (echo "liberyx_bindings.so.zst missing!" && exit 1)

          # Touch to mark as up-to-date
          touch crates/eryx-runtime/runtime.wasm
          touch crates/eryx-runtime/prebuilt/*

          echo "=== All artifacts verified ==="

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2

      - name: Pre-compile WASM for this platform (with Python pre-init)
        shell: bash
        run: |
          echo "Pre-compiling WASM for Windows x64 with Python pre-initialization..."
          cargo run -p eryx --example precompile --features preinit --release
          ls -la crates/eryx-runtime/runtime.cwasm

      - name: Mark cwasm as up-to-date
        shell: bash
        run: touch crates/eryx-runtime/runtime.cwasm

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          architecture: ${{ matrix.target }}

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --manifest-path crates/eryx-python/Cargo.toml

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-windows-${{ matrix.target }}
          path: dist

      - name: Test wheel
        shell: bash
        run: |
          python -m pip install pytest
          python -m pip install dist/*.whl --force-reinstall
          cd crates/eryx-python && pytest tests/ -v

  # Build source distribution
  sdist:
    name: Source Distribution
    runs-on: namespace-profile-eryx-heavy-linux-amd64
    needs: build-runtime
    steps:
      - uses: actions/checkout@v4

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: crates/

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist --manifest-path crates/eryx-python/Cargo.toml

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: wheels-sdist
          path: dist

  # Publish to PyPI
  release:
    name: Publish to PyPI
    runs-on: namespace-profile-eryx-light
    if: startsWith(github.ref, 'refs/tags/py-v') || (github.event_name == 'workflow_dispatch' && inputs.publish)
    needs:
      [linux-x86_64, linux-aarch64, macos-aarch64, macos-x86_64, windows, sdist]
    environment: pypi
    permissions:
      id-token: write
      contents: write
      attestations: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist

      - name: List wheels
        run: ls -la dist/

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: "dist/*"

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          skip-existing: true
