# Python wheel release workflow for eryx-python
#
# This workflow builds and publishes Python wheels for multiple platforms.
# It runs on:
# - Tags starting with 'py-v' (e.g., py-v0.1.0)
# - Manual workflow dispatch
#
# To release:
# 1. Update version in crates/eryx-python/Cargo.toml and pyproject.toml
# 2. git tag py-v0.1.0
# 3. git push origin py-v0.1.0

name: Python Release

on:
  push:
    tags:
      - "py-v*"
  workflow_dispatch:
    inputs:
      publish:
        description: "Publish to PyPI"
        required: false
        default: false
        type: boolean

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build the WASM runtime first - required for all wheel builds
  build-runtime:
    name: Build Runtime
    runs-on: namespace-profile-eryx-heavy
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install nightly toolchain
        run: rustup toolchain install nightly --component rust-src

      - name: Install mise
        uses: jdx/mise-action@v3

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2

      - name: Build eryx-runtime
        run: mise run build-eryx-runtime

      - name: Precompile WASM
        # Use -p eryx to avoid building eryx-python (circular dependency:
        # eryx-python enables 'embedded' which requires runtime.cwasm to exist)
        run: cargo run -p eryx --example precompile --release

      - name: Copy prebuilt late-linking artifacts
        run: |
          OUT_DIR=$(find target/release -path "*/eryx-runtime-*/out" -type d | head -1)
          mkdir -p crates/eryx-runtime/prebuilt
          cp "$OUT_DIR/liberyx_runtime.so.zst" crates/eryx-runtime/prebuilt/
          cp "$OUT_DIR/liberyx_bindings.so.zst" crates/eryx-runtime/prebuilt/

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-runtime
          path: |
            crates/eryx-runtime/runtime.wasm
            crates/eryx-runtime/runtime.cwasm
            crates/eryx-runtime/prebuilt/
          retention-days: 1

  # Build wheels for Linux (manylinux)
  linux:
    name: Linux (${{ matrix.target }})
    runs-on: namespace-profile-eryx-heavy
    needs: build-runtime
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64
          - aarch64
    steps:
      - uses: actions/checkout@v4

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: .

      - name: Mark WASM as up-to-date
        run: |
          touch crates/eryx-runtime/runtime.wasm crates/eryx-runtime/runtime.cwasm
          if [ -d crates/eryx-runtime/prebuilt ]; then
            touch crates/eryx-runtime/prebuilt/*
          fi

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --manifest-path crates/eryx-python/Cargo.toml
          manylinux: auto

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-${{ matrix.target }}
          path: dist

      - name: Test wheel (x86_64 only)
        if: matrix.target == 'x86_64'
        run: |
          pip install pytest
          pip install eryx --find-links dist --force-reinstall
          cd crates/eryx-python && pytest tests/ -v

  # Build wheels for macOS
  macos:
    name: macOS (${{ matrix.target }})
    runs-on: ${{ matrix.runner }}
    needs: build-runtime
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15
            target: aarch64
          - runner: macos-15-intel
            target: x86_64
    steps:
      - uses: actions/checkout@v4

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: .

      - name: Mark WASM as up-to-date
        run: |
          touch crates/eryx-runtime/runtime.wasm crates/eryx-runtime/runtime.cwasm
          if [ -d crates/eryx-runtime/prebuilt ]; then
            touch crates/eryx-runtime/prebuilt/*
          fi

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --manifest-path crates/eryx-python/Cargo.toml

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-${{ matrix.target }}
          path: dist

      - name: Test wheel
        run: |
          pip install pytest
          pip install eryx --find-links dist --force-reinstall
          cd crates/eryx-python && pytest tests/ -v

  # Build wheels for Windows
  windows:
    name: Windows (${{ matrix.target }})
    runs-on: windows-latest
    needs: build-runtime
    strategy:
      fail-fast: false
      matrix:
        target:
          - x64
    steps:
      - uses: actions/checkout@v4

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: .

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          architecture: ${{ matrix.target }}

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --manifest-path crates/eryx-python/Cargo.toml

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-windows-${{ matrix.target }}
          path: dist

      - name: Test wheel
        shell: bash
        run: |
          pip install pytest
          pip install eryx --find-links dist --force-reinstall
          cd crates/eryx-python && pytest tests/ -v

  # Build source distribution
  sdist:
    name: Source Distribution
    runs-on: namespace-profile-eryx-heavy
    needs: build-runtime
    steps:
      - uses: actions/checkout@v4

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-runtime
          path: .

      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist --manifest-path crates/eryx-python/Cargo.toml

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: wheels-sdist
          path: dist

  # Publish to PyPI
  release:
    name: Publish to PyPI
    runs-on: namespace-profile-eryx-light
    if: startsWith(github.ref, 'refs/tags/py-v') || (github.event_name == 'workflow_dispatch' && inputs.publish)
    needs: [linux, macos, windows, sdist]
    environment: pypi
    permissions:
      id-token: write
      contents: write
      attestations: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist

      - name: List wheels
        run: ls -la dist/

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: "dist/*"

      - name: Publish to PyPI
        uses: PyO3/maturin-action@v1
        with:
          command: upload
          args: --non-interactive --skip-existing dist/*
