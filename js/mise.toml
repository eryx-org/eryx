[tools]
node = "24"
"npm:@bytecodealliance/jco" = "1.16.1"

# =============================================================================
# JavaScript bindings tasks (browser/Node.js via jco)
# =============================================================================

[tasks.wasm-build]
description = "Build eryx WASM runtime (delegates to root mise task)"
sources = [
  "../crates/eryx-wasm-runtime/src/**/*.rs",
  "../crates/eryx-wasm-runtime/Cargo.toml",
  "../crates/eryx-runtime/wit/**/*.wit",
]
outputs = ["../crates/eryx-runtime/runtime.wasm"]
run = """
cd .. && mise run build-eryx-runtime
"""

[tasks.preinit]
description = "Pre-initialize Python in the WASM component (bakes in stdlib)"
depends = ["wasm-build"]
sources = ["../crates/eryx-runtime/runtime.wasm"]
outputs = ["../crates/eryx-runtime/runtime-preinit.wasm"]
env = { ERYX_PRECOMPILE_BOOTSTRAP = "1" }
run = """
cd .. && cargo run -p eryx-precompile --release -- \
  crates/eryx-runtime/runtime.wasm \
  --preinit \
  --stdlib crates/eryx-wasm-runtime/tests/python-stdlib \
  --wasm-only \
  --output crates/eryx-runtime/runtime-preinit.wasm \
  --no-verify
"""

[tasks.transpile]
description = "Transpile WASM component to JavaScript using jco"
depends = ["preinit"]
sources = ["../crates/eryx-runtime/runtime-preinit.wasm"]
outputs = ["eryx-sandbox/eryx-sandbox.js", "eryx-sandbox/eryx-sandbox.core.wasm"]
run = """
jco transpile \
  ../crates/eryx-runtime/runtime-preinit.wasm \
  --name eryx-sandbox \
  --out-dir eryx-sandbox \
  --map 'eryx:net/tcp=./shims/net.js#tcp' \
  --map 'eryx:net/tls=./shims/net.js#tls' \
  --map 'invoke=./shims/callbacks.js#invoke' \
  --map 'list-callbacks=./shims/callbacks.js#listCallbacks' \
  --map 'report-trace=./shims/callbacks.js#reportTrace' \
  --map 'wasi:sockets/*=./shims/sockets.js#*'
"""

[tasks.patch-js]
description = "Patch generated JS for webpack compat and jco codegen bugs"
depends = ["transpile"]
sources = ["eryx-sandbox/eryx-sandbox.js"]
outputs = ["eryx-sandbox/eryx-sandbox.js"]
run = """
#!/usr/bin/env node
const fs = require('fs');
const path = 'eryx-sandbox/eryx-sandbox.js';
let code = fs.readFileSync(path, 'utf8');
let patched = false;

// Patch 1: webpack compatibility for node:fs/promises
const fsOriginal = `  if (isNode) {
    _fs = _fs || await import('node:fs/promises');
    return WebAssembly.compile(await _fs.readFile(url));
  }`;

const fsPatched = `  if (isNode) {
    if (!_fs) {
      try {
        _fs = await import(/* webpackIgnore: true */ 'node:fs/promises');
      } catch {
        // Fallback for environments where node:fs/promises is unavailable
      }
    }
    if (_fs) {
      return WebAssembly.compile(await _fs.readFile(url));
    }
  }`;

if (code.includes(fsOriginal)) {
  code = code.replace(fsOriginal, fsPatched);
  console.log('Patched: webpack compatibility for node:fs/promises');
  patched = true;
} else if (code.includes('webpackIgnore')) {
  console.log('Already patched: webpack compatibility');
} else {
  console.error('Warning: Could not find fetchCompile pattern to patch');
}

// Patch 2: Fix jco codegen bug - 'for...in' should be 'for...of' in record lifting
const forInBug = 'for (const [key, liftFn, alignment32] in keysAndLiftFns)';
const forOfFix = 'for (const [key, liftFn, alignment32] of keysAndLiftFns)';
if (code.includes(forInBug)) {
  code = code.replace(forInBug, forOfFix);
  console.log('Patched: for...in -> for...of in _liftFlatRecordInner');
  patched = true;
}

// Patch 3: Fix jco codegen bug - bad variable references in _liftFlatStringUTF8
// The generated code references undefined 'params' and 'memory' variables,
// and incorrectly advances storagePtr by codeUnits instead of 8.
const stringLiftBug = `const start = new DataView(ctx.memory.buffer).getUint32(ctx.storagePtr, params[0], true);
    const codeUnits = new DataView(memory.buffer).getUint32(ctx.storagePtr, params[0] + 4, true);
    val = TEXT_DECODER_UTF8.decode(new Uint8Array(ctx.memory.buffer, start, codeUnits));
    ctx.storagePtr += codeUnits;
    ctx.storageLen -= codeUnits;`;
const stringLiftFix = `const start = new DataView(ctx.memory.buffer).getUint32(ctx.storagePtr, true);
    const codeUnits = new DataView(ctx.memory.buffer).getUint32(ctx.storagePtr + 4, true);
    val = TEXT_DECODER_UTF8.decode(new Uint8Array(ctx.memory.buffer, start, codeUnits));
    ctx.storagePtr += 8;
    ctx.storageLen -= 8;`;
if (code.includes(stringLiftBug)) {
  code = code.replace(stringLiftBug, stringLiftFix);
  console.log('Patched: _liftFlatStringUTF8 variable references and pointer advancement');
  patched = true;
}

// Patch 4: Fix _liftFlatRecordInner return value - should return [res, ctx] not just res
const recordReturnBug = /return res;\n  \}\n\}/;
const recordReturnBugStr = `    return res;\n  }\n}`;
if (code.includes(recordReturnBugStr)) {
  code = code.replace(recordReturnBugStr, `    return [res, ctx];\n  }\n}`);
  console.log('Patched: _liftFlatRecordInner return [res, ctx]');
  patched = true;
}

// Patch 5: Fix const destructuring + reassignment in _liftFlatRecordInner
const constReassignBug = `    const { memory, useDirectParams, storagePtr, storageLen, params } = ctx;

    if (useDirectParams) {
      storagePtr = params[0]
    }`;
const constReassignFix = `    const { memory, useDirectParams, storagePtr, storageLen, params } = ctx;`;
if (code.includes(constReassignBug)) {
  code = code.replace(constReassignBug, constReassignFix);
  console.log('Patched: removed const reassignment in _liftFlatRecordInner');
  patched = true;
}

// Patch 6: Fix useDirectParams: false for result-returning async export trampolines
// The task.return for execute() passes flat values as direct params, not storage buffer ptrs
const useDirectBug = /useDirectParams: false,\n\s+getMemoryFn:/;
if (useDirectBug.test(code)) {
  code = code.replace(useDirectBug, 'useDirectParams: true,\n  getMemoryFn:');
  console.log('Patched: useDirectParams false -> true in taskReturn trampoline');
  patched = true;
}

if (patched) {
  fs.writeFileSync(path, code);
}
"""

[tasks.build]
description = "Build JavaScript bindings (WASM + transpile + version sync)"
depends = ["patch-js"]
sources = ["eryx-sandbox/eryx-sandbox.js", "../Cargo.toml"]
outputs = ["eryx-sandbox/package.json"]
run = """
#!/usr/bin/env bash
set -euo pipefail
VERSION=$(cargo metadata --format-version 1 --manifest-path ../Cargo.toml | jq -r '.packages[] | select(.name == "eryx") | .version')
jq --arg v "$VERSION" '.version = $v' eryx-sandbox/package.json > eryx-sandbox/package.json.tmp
mv eryx-sandbox/package.json.tmp eryx-sandbox/package.json
"""

[tasks.test]
description = "Run JavaScript tests"
depends = ["build"]
sources = ["eryx-sandbox/**/*.js", "eryx-sandbox/**/*.wasm", "testpkg/**/*.ts"]
dir = "testpkg"
run = """
cd ../eryx-sandbox && npm ci
cd ../testpkg && npm ci && npm run typecheck && npm run test:ci
"""

[tasks.clean]
description = "Clean JavaScript build artifacts (generated files only)"
dir = "eryx-sandbox"
run = "rm -rf eryx-sandbox.js eryx-sandbox.d.ts eryx-sandbox.core*.wasm interfaces"

[tasks.publish]
description = "Publish JavaScript package to npm"
depends = ["test"]
dir = "eryx-sandbox"
run = "npm publish --access public"
