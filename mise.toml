[tools]
# Profile "default" includes rustc, rust-std, cargo, rust-docs, rustfmt, and clippy
rust = { version = "1.89", profile = "default" }
"cargo:cargo-nextest" = "latest"
uv = "latest"

[tasks.check]
description = "Run cargo check"
run = "cargo check --workspace"

[tasks.build]
description = "Build all crates"
run = "cargo build --workspace"

[tasks.test]
description = "Run tests with precompiled WASM"
depends = ["precompile-wasm"]
run = "cargo nextest run --workspace --features precompiled"

[tasks.test-all]
description = "Run tests with all features"
run = "cargo nextest run --workspace --all-features"

[tasks.lint]
description = "Run clippy lints"
run = "cargo clippy --workspace --all-targets --all-features -- -D warnings"

[tasks.lint-fix]
description = "Auto-fix clippy warnings"
run = "cargo clippy --fix --allow-dirty --workspace --all-targets --all-features"

[tasks.fmt]
description = "Format code"
run = "cargo fmt --all"

[tasks.fmt-check]
description = "Check code formatting"
run = "cargo fmt --all -- --check"

[tasks.doc]
description = "Generate documentation"
run = "cargo doc --workspace --no-deps --all-features"

[tasks.doc-open]
description = "Generate and open documentation"
run = "cargo doc --workspace --no-deps --open"

[tasks.ci]
description = "Run all CI checks"
depends = ["fmt-check", "lint", "test"]

[tasks.clean]
description = "Clean build artifacts"
run = "cargo clean"

[tasks.build-wasm]
description = "Build the Python WASM component"
dir = "crates/eryx-runtime"
run = """
uv sync
uv run componentize-py -d runtime.wit -w sandbox bindings guest_bindings
uv run componentize-py -d runtime.wit -w sandbox componentize runtime -o runtime.wasm
"""

[tasks.build-all]
description = "Build WASM component and Rust crates"
depends = ["build-wasm", "build"]

[tasks.bench]
description = "Run benchmarks"
run = "cargo bench --package eryx"

[tasks.bench-save]
description = "Run benchmarks and save baseline"
run = "cargo bench --package eryx -- --save-baseline main"

[tasks.precompile-wasm]
description = "Pre-compile WASM to native code for faster loading"
depends = ["build-wasm"]
run = "cargo run --example precompile --features precompiled --release"
sources = ["crates/eryx-runtime/runtime.wasm"]
outputs = ["crates/eryx-runtime/runtime.cwasm"]

[tasks.setup]
description = "Set up development environment (build WASM, precompile, etc.)"
depends = ["build-wasm", "precompile-wasm"]
run = """
echo "✓ Development environment ready!"
echo ""
echo "Available commands:"
echo "  mise run test       - Run tests (~0.1s with precompiled WASM)"
echo "  mise run ci         - Run all CI checks"
echo "  mise run build-all  - Build WASM and Rust crates"
"""

[tasks.build-all-precompiled]
description = "Build WASM, pre-compile it, and build Rust crates"
depends = ["build-wasm", "build"]

[tasks.msrv]
description = "Check compilation on minimum supported Rust version"
run = "cargo +1.89 check --workspace"

[tasks.example-demo]
description = "Run the demo example"
depends = ["build-wasm"]
run = "cargo run --example trace_events --features embedded-runtime"

[tasks.examples]
description = "Run all examples"
depends = ["build-wasm"]
run = """
echo "=== simple ==="
cargo run --example simple --release
echo ""
echo "=== parallel_callbacks ==="
cargo run --example parallel_callbacks --release
echo ""
echo "=== with_tracing ==="
cargo run --example with_tracing --release
echo ""
echo "=== error_handling ==="
cargo run --example error_handling --release
echo ""
echo "=== resource_limits ==="
cargo run --example resource_limits --release
echo ""
echo "=== custom_library ==="
cargo run --example custom_library --release
echo ""
echo "=== session_reuse ==="
cargo run --example session_reuse --release
echo ""
echo "=== precompile (requires precompiled feature) ==="
cargo run --example precompile --features precompiled --release
echo ""
echo "=== embedded_runtime (requires embedded-runtime feature) ==="
cargo run --example embedded_runtime --features embedded-runtime --release
echo ""
echo "✓ All examples completed!"
"""
