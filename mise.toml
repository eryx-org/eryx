[tools]
# Profile "default" includes rustc, rust-std, cargo, rust-docs, rustfmt, and clippy
rust = { version = "1.89", profile = "default" }
"cargo:cargo-nextest" = "latest"
uv = "latest"

[tasks.check]
description = "Run cargo check"
run = "cargo check --workspace"

[tasks.build]
description = "Build all crates"
run = "cargo build --workspace"

[tasks.test]
description = "Run tests with nextest"
run = "cargo nextest run --workspace"

[tasks.test-fast]
description = "Run tests with precompiled WASM (much faster)"
depends = ["precompile-wasm"]
run = "cargo nextest run --workspace --features precompiled"

[tasks.test-all]
description = "Run tests with all features"
run = "cargo nextest run --workspace --all-features"

[tasks.lint]
description = "Run clippy lints"
run = "cargo clippy --workspace --all-targets --all-features -- -D warnings"

[tasks.fmt]
description = "Format code"
run = "cargo fmt --all"

[tasks.fmt-check]
description = "Check code formatting"
run = "cargo fmt --all -- --check"

[tasks.doc]
description = "Generate documentation"
run = "cargo doc --workspace --no-deps --all-features"

[tasks.doc-open]
description = "Generate and open documentation"
run = "cargo doc --workspace --no-deps --open"

[tasks.ci]
description = "Run all CI checks"
depends = ["fmt-check", "lint", "test-fast"]

[tasks.clean]
description = "Clean build artifacts"
run = "cargo clean"

[tasks.build-wasm]
description = "Build the Python WASM component"
dir = "crates/eryx-runtime"
run = """
uv sync
uv run componentize-py -d runtime.wit -w sandbox bindings guest_bindings
uv run componentize-py -d runtime.wit -w sandbox componentize runtime -o runtime.wasm
"""

[tasks.build-all]
description = "Build WASM component and Rust crates"
depends = ["build-wasm", "build"]

[tasks.bench]
description = "Run benchmarks"
run = "cargo bench --package eryx"

[tasks.bench-save]
description = "Run benchmarks and save baseline"
run = "cargo bench --package eryx -- --save-baseline main"

[tasks.precompile-wasm]
description = "Pre-compile WASM to native code for faster loading"
depends = ["build-wasm"]
run = "cargo run --example precompile --features precompiled --release"
sources = ["crates/eryx-runtime/runtime.wasm"]
outputs = ["crates/eryx-runtime/runtime.cwasm"]

[tasks.setup]
description = "Set up development environment (build WASM, precompile, etc.)"
depends = ["build-wasm", "precompile-wasm"]
run = """
echo "âœ“ Development environment ready!"
echo ""
echo "Available commands:"
echo "  mise run test-fast  - Run tests with precompiled WASM (~0.1s)"
echo "  mise run test       - Run tests without precompilation (~50s)"
echo "  mise run ci         - Run all CI checks"
echo "  mise run build-all  - Build WASM and Rust crates"
"""

[tasks.build-all-precompiled]
description = "Build WASM, pre-compile it, and build Rust crates"
depends = ["build-wasm", "build"]

[tasks.msrv]
description = "Check compilation on minimum supported Rust version"
run = "cargo +1.89 check --workspace"

[tasks.integration]
description = "Run integration tests (build WASM and run examples)"
depends = ["build-wasm"]
run = """
cargo run --example simple --release
cargo run --example parallel_callbacks --release
cargo run --example precompile --features precompiled --release
cargo run --example embedded_runtime --features embedded-runtime --release
"""
