[tools]
# Profile "default" includes rustc, rust-std, cargo, rust-docs, rustfmt, and clippy
rust = { version = "1.92", profile = "default" }

[tools."cargo:cargo-nextest"]
version = "0.9.114"

[tools."cargo:wasm-tools"]
version = "1.243.0"

[tools."cargo:cargo-rail"]
version = "0.8.1"

[tools."cargo:cargo-all-features"]
version = "1.12.0"

# Note: WASI SDK is intentionally NOT in [tools] because adding it to PATH
# breaks host compilation (Rust picks up wasm clang for proc-macro builds).
# Instead, we install it on-demand via the ensure-wasi-sdk task.

[vars]
wasi_sdk_version = "wasi-sdk-27"

[tasks.check]
description = "Run cargo check"
run = "cargo check --workspace"

[tasks.build]
description = "Build all crates"
run = "cargo build --workspace"

[tasks.test]
description = "Run tests with embedded WASM"
depends = ["precompile-eryx-runtime", "setup-eryx-runtime-tests"]
run = "cargo nextest run --workspace --features embedded"

[tasks.test-python]
description = "Run Python binding tests"
depends = ["precompile-eryx-runtime"]
dir = "crates/eryx-python"
run = """
maturin develop --release
.venv/bin/pytest tests/ -v
"""

[tasks.test-all]
description = "Run tests with all features"
depends = ["precompile-eryx-runtime", "build-preinit", "setup-eryx-runtime-tests"]
run = "cargo nextest run --workspace --all-features"

[tasks.lint]
description = "Run clippy lints"
depends = ["build-preinit"]
run = "cargo clippy --workspace --all-targets --all-features -- -D warnings"

[tasks.lint-fix]
description = "Auto-fix clippy warnings"
depends = ["build-preinit"]
run = "cargo clippy --fix --allow-dirty --workspace --all-targets --all-features"

[tasks.fmt]
description = "Format code"
run = "cargo fmt --all"

[tasks.fmt-check]
description = "Check code formatting"
run = "cargo fmt --all -- --check"

[tasks.doc]
description = "Generate documentation"
depends = ["build-preinit"]
run = "cargo doc --workspace --no-deps --all-features"

[tasks.doc-open]
description = "Generate and open documentation"
run = "cargo doc --workspace --no-deps --open"

[tasks.ci]
description = "Run all CI checks"
depends = ["fmt-check", "lint", "test"]

[tasks.unify]
description = "Unify workspace dependencies and prune dead features"
run = "cargo rail unify"

[tasks.unify-check]
description = "Check for dependency drift (CI)"
run = "cargo rail unify --check"

[tasks.affected]
description = "List affected crates"
run = "cargo rail affected"

[tasks.check-all-features]
description = "Check all feature combinations compile"
run = "cargo check-all-features"

[tasks.test-all-features]
description = "Test all feature combinations"
depends = ["build-eryx-runtime"]
run = "cargo test-all-features"

[tasks.clean]
description = "Clean build artifacts"
run = "cargo clean"

[tasks.clean-artifacts]
description = "Clean WASM artifacts and extracted stdlibs (simulate CI fresh state)"
run = """
echo "Removing WASM artifacts..."
rm -f crates/eryx-runtime/runtime.wasm
rm -f crates/eryx-runtime/runtime.cwasm

echo "Removing prebuilt artifacts..."
rm -rf crates/eryx-runtime/prebuilt/

echo "Removing extracted stdlib for eryx-wasm-runtime tests..."
rm -rf crates/eryx-wasm-runtime/tests/python-stdlib
rm -rf crates/eryx-wasm-runtime/tests/site-packages
rm -f crates/eryx-wasm-runtime/target/liberyx_runtime.so

echo "Removing system temp extracted resources..."
rm -rf "${TMPDIR:-/tmp}/eryx-embedded"

echo "✓ Artifacts cleaned. Run 'mise run setup' to rebuild."
"""

[tasks.build-eryx-runtime]
description = "Build the eryx-wasm-runtime and runtime.wasm"
depends = ["ensure-wasi-sdk"]
run = """
export WASI_SDK_PATH=$(mise where "github:WebAssembly/wasi-sdk@{{vars.wasi_sdk_version}}")
BUILD_ERYX_RUNTIME=1 cargo build --package eryx-runtime --release
"""
sources = [
  "crates/eryx-wasm-runtime/src/**/*.rs",
  "crates/eryx-wasm-runtime/clock_stubs.c",
  "crates/eryx-wasm-runtime/Cargo.toml",
  "crates/eryx-runtime/runtime.wit",
]
outputs = ["crates/eryx-runtime/runtime.wasm"]

[tasks.build-preinit]
description = "Build preinit artifacts (liberyx_runtime.so.zst, etc.)"
depends = ["build-eryx-runtime"]
run = "cargo build --package eryx-runtime --features preinit --release"

[tasks.build-all]
description = "Build WASM component and Rust crates"
depends = ["build-eryx-runtime", "build"]

[tasks.bench]
description = "Run benchmarks"
depends = ["precompile-eryx-runtime-preinit"]
run = "cargo bench --package eryx --all-features"

[tasks.bench-save]
description = "Run benchmarks and save baseline"
depends = ["precompile-eryx-runtime-preinit"]
run = "cargo bench --package eryx --all-features -- --save-baseline main"

[tasks.precompile-eryx-runtime]
description = "Pre-compile eryx-runtime WASM to native code for faster loading"
depends = ["build-eryx-runtime"]
# Note: no --features embedded here - precompile must bootstrap without runtime.cwasm
run = "cargo run -p eryx --example precompile --release"
sources = ["crates/eryx-runtime/runtime.wasm"]
outputs = ["crates/eryx-runtime/runtime.cwasm"]

[tasks.precompile-eryx-runtime-preinit]
description = "Pre-initialize Python and pre-compile runtime (faster sessions, requires preinit)"
depends = ["build-eryx-runtime", "build-preinit", "setup-eryx-runtime-tests"]
# Note: no --features embedded here - precompile must bootstrap without runtime.cwasm
run = "cargo run --example precompile --features preinit --release"
sources = [
  "crates/eryx-runtime/runtime.wasm",
  "crates/eryx-wasm-runtime/tests/python-stdlib/encodings/__init__.py",
]
outputs = ["crates/eryx-runtime/runtime.cwasm"]

[tasks.setup]
description = "Set up development environment (build WASM, precompile, etc.)"
depends = ["build-eryx-runtime", "precompile-eryx-runtime"]
run = """
echo "✓ Development environment ready!"
echo ""
echo "Available commands:"
echo "  mise run test       - Run tests (~0.1s with precompiled WASM)"
echo "  mise run ci         - Run all CI checks"
echo "  mise run build-all  - Build WASM and Rust crates"
"""

[tasks.build-all-precompiled]
description = "Build WASM, pre-compile it, and build Rust crates"
depends = ["build-eryx-runtime", "build"]

[tasks.msrv]
description = "Check compilation on minimum supported Rust version"
run = "cargo +1.89 check --workspace"

[tasks.example-demo]
description = "Run the demo example"
depends = ["build-eryx-runtime"]
run = "cargo run --example trace_events --features embedded"

[tasks.examples]
description = "Run all examples"
depends = ["precompile-eryx-runtime"]
run = """
echo "=== simple ==="
cargo run --example simple --features embedded --release
echo ""
echo "=== parallel_callbacks ==="
cargo run --example parallel_callbacks --features embedded --release
echo ""
echo "=== with_tracing ==="
cargo run --example with_tracing --features embedded --release
echo ""
echo "=== error_handling ==="
cargo run --example error_handling --features embedded --release
echo ""
echo "=== resource_limits ==="
cargo run --example resource_limits --features embedded --release
echo ""
echo "=== custom_library ==="
cargo run --example custom_library --features embedded --release
echo ""
echo "=== session_reuse ==="
cargo run --example session_reuse --features embedded --release
echo ""
echo "=== runtime_callbacks ==="
cargo run --example runtime_callbacks --features embedded --release
echo ""
echo "=== trace_events ==="
cargo run --example trace_events --features embedded --release
echo ""
echo "=== precompile ==="
cargo run --example precompile --release
echo ""
echo "=== embedded_runtime ==="
cargo run --example embedded_runtime --features embedded --release
echo ""
echo "✓ All examples completed!"
"""

[tasks.ensure-wasi-sdk]
description = "Install WASI SDK if not present"
run = """
WASI_SDK_SPEC="github:WebAssembly/wasi-sdk@{{vars.wasi_sdk_version}}"
if ! mise where "$WASI_SDK_SPEC" 2>/dev/null; then
    echo "Installing WASI SDK ({{vars.wasi_sdk_version}})..."
    mise install "$WASI_SDK_SPEC"
fi

WASI_SDK_PATH=$(mise where "$WASI_SDK_SPEC")
if [ ! -f "$WASI_SDK_PATH/bin/clang" ]; then
    echo "ERROR: WASI SDK installation incomplete - clang not found"
    exit 1
fi
echo "Using WASI SDK at: $WASI_SDK_PATH"
"""

[tasks.setup-eryx-runtime-tests]
description = "Extract Python stdlib and copy liberyx_runtime.so for eryx-wasm-runtime tests"
depends = ["build-eryx-runtime"]
dir = "crates/eryx-wasm-runtime"
run = """
mkdir -p tests/python-stdlib tests/site-packages target

# Extract Python stdlib
PYTHON_LIB="../eryx/python-stdlib.tar.zst"
if [[ ! -f "$PYTHON_LIB" ]]; then
    echo "Error: python-stdlib.tar.zst not found at $PYTHON_LIB"
    exit 1
fi
echo "Extracting $PYTHON_LIB"
# Extract to a temp location first, then move contents (archive has python-stdlib/ prefix)
rm -rf tests/python-stdlib-tmp
mkdir -p tests/python-stdlib-tmp
tar -xf "$PYTHON_LIB" -C tests/python-stdlib-tmp
# Move contents from nested directory to final location
rm -rf tests/python-stdlib
mv tests/python-stdlib-tmp/python-stdlib tests/python-stdlib
rm -rf tests/python-stdlib-tmp

# Copy liberyx_runtime.so from build output (skip if already exists, e.g. in CI)
if [[ -f "target/liberyx_runtime.so" ]]; then
    echo "liberyx_runtime.so already exists in target/, skipping copy"
else
    # Search in both release and debug build directories
    OUT_DIR=$(find ../../target -path "*/eryx-runtime-*/out/liberyx_runtime.so" -type f 2>/dev/null | head -1)
    if [[ -z "$OUT_DIR" ]]; then
        echo "Error: liberyx_runtime.so not found in target. Run 'mise run build-eryx-runtime' first."
        exit 1
    fi
    echo "Copying $OUT_DIR to target/"
    cp "$OUT_DIR" target/liberyx_runtime.so
fi
"""

[tasks.test-eryx-runtime]
description = "Run eryx-wasm-runtime integration tests"
depends = ["build-eryx-runtime", "setup-eryx-runtime-tests"]
run = "cargo test --package eryx-wasm-runtime --test runtime_test -- --nocapture"
