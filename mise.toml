[tools]
# Profile "default" includes rustc, rust-std, cargo, rust-docs, rustfmt, and clippy
rust = { version = "1.92", profile = "default" }
uv = "latest"

[tools."cargo:cargo-nextest"]
version = "latest"
binstall = true

[tools."cargo:wasm-tools"]
version = "latest"
binstall = true

# Note: WASI SDK is intentionally NOT in [tools] because adding it to PATH
# breaks host compilation (Rust picks up wasm clang for proc-macro builds).
# Instead, we install it on-demand via the ensure-wasi-sdk task.
# The build.rs script finds it via `mise where`.

[tasks.check]
description = "Run cargo check"
run = "cargo check --workspace"

[tasks.build]
description = "Build all crates"
run = "cargo build --workspace"

[tasks.test]
description = "Run tests with precompiled WASM"
depends = ["precompile-wasm"]
run = """
export WASI_SDK_PATH=$(mise where github:WebAssembly/wasi-sdk@wasi-sdk-27)
cargo nextest run --workspace --features precompiled
"""

[tasks.test-all]
description = "Run tests with all features"
depends = ["precompile-wasm"]
run = """
export WASI_SDK_PATH=$(mise where github:WebAssembly/wasi-sdk@wasi-sdk-27)
cargo nextest run --workspace --all-features
"""

[tasks.lint]
description = "Run clippy lints"
depends = ["build-wasm"]
run = """
export WASI_SDK_PATH=$(mise where github:WebAssembly/wasi-sdk@wasi-sdk-27)
cargo clippy --workspace --all-targets --all-features -- -D warnings
"""

[tasks.lint-fix]
description = "Auto-fix clippy warnings"
depends = ["build-wasm"]
run = "cargo clippy --fix --allow-dirty --workspace --all-targets --all-features"

[tasks.fmt]
description = "Format code"
run = "cargo fmt --all"

[tasks.fmt-check]
description = "Check code formatting"
run = "cargo fmt --all -- --check"

[tasks.doc]
description = "Generate documentation"
depends = ["precompile-wasm"]
run = """
# Set WASI_SDK_PATH for build.rs if triggered during doc generation
export WASI_SDK_PATH=$(mise where github:WebAssembly/wasi-sdk@wasi-sdk-27)
cargo doc --workspace --no-deps --all-features
"""

[tasks.doc-open]
description = "Generate and open documentation"
run = "cargo doc --workspace --no-deps --open"

[tasks.ci]
description = "Run all CI checks"
depends = ["fmt-check", "lint", "test"]

[tasks.clean]
description = "Clean build artifacts"
run = "cargo clean"

[tasks.build-wasm]
description = "Build the Python WASM component using eryx-wasm-runtime"
depends = ["ensure-wasi-sdk"]
run = """
# Get WASI SDK path and export it for build.rs (use explicit version)
export WASI_SDK_PATH=$(mise where github:WebAssembly/wasi-sdk@wasi-sdk-27)
echo "Using WASI SDK at: $WASI_SDK_PATH"
BUILD_ERYX_RUNTIME=1 cargo build --package eryx-runtime --release
"""
sources = ["crates/eryx-wasm-runtime/src/**/*.rs", "crates/eryx-wasm-runtime/clock_stubs.c", "crates/eryx-runtime/runtime.wit"]
outputs = ["crates/eryx-runtime/runtime.wasm"]

[tasks.build-all]
description = "Build WASM component and Rust crates"
depends = ["build-wasm", "build"]

[tasks.bench]
description = "Run benchmarks"
run = "cargo bench --package eryx"

[tasks.bench-save]
description = "Run benchmarks and save baseline"
run = "cargo bench --package eryx -- --save-baseline main"

[tasks.precompile-wasm]
description = "Pre-compile WASM to native code for faster loading"
depends = ["build-wasm"]
run = "cargo run --example precompile --features precompiled --release"
sources = ["crates/eryx-runtime/runtime.wasm"]
outputs = ["crates/eryx-runtime/runtime.cwasm"]

[tasks.setup]
description = "Set up development environment (build WASM, precompile, etc.)"
depends = ["build-wasm", "precompile-wasm"]
run = """
echo "✓ Development environment ready!"
echo ""
echo "Available commands:"
echo "  mise run test       - Run tests (~0.1s with precompiled WASM)"
echo "  mise run ci         - Run all CI checks"
echo "  mise run build-all  - Build WASM and Rust crates"
"""

[tasks.build-all-precompiled]
description = "Build WASM, pre-compile it, and build Rust crates"
depends = ["build-wasm", "build"]

[tasks.msrv]
description = "Check compilation on minimum supported Rust version"
run = "cargo +1.89 check --workspace"

[tasks.example-demo]
description = "Run the demo example"
depends = ["build-wasm"]
run = "cargo run --example trace_events --features embedded-runtime"

[tasks.examples]
description = "Run all examples"
depends = ["build-wasm"]
run = """
echo "=== simple ==="
cargo run --example simple --release
echo ""
echo "=== parallel_callbacks ==="
cargo run --example parallel_callbacks --release
echo ""
echo "=== with_tracing ==="
cargo run --example with_tracing --release
echo ""
echo "=== error_handling ==="
cargo run --example error_handling --release
echo ""
echo "=== resource_limits ==="
cargo run --example resource_limits --release
echo ""
echo "=== custom_library ==="
cargo run --example custom_library --release
echo ""
echo "=== session_reuse ==="
cargo run --example session_reuse --release
echo ""
echo "=== precompile (requires precompiled feature) ==="
cargo run --example precompile --features precompiled --release
echo ""
echo "=== embedded_runtime (requires embedded-runtime feature) ==="
cargo run --example embedded_runtime --features embedded-runtime --release
echo ""
echo "✓ All examples completed!"
"""

# =============================================================================
# eryx-wasm-runtime tasks
# =============================================================================

[tasks.ensure-wasi-sdk]
description = "Install WASI SDK if not present"
run = """
# Install WASI SDK if not present (use explicit version in all commands)
WASI_SDK_VERSION="wasi-sdk-27"
if ! mise where "github:WebAssembly/wasi-sdk@$WASI_SDK_VERSION" 2>/dev/null; then
    echo "Installing WASI SDK ($WASI_SDK_VERSION)..."
    mise install "github:WebAssembly/wasi-sdk@$WASI_SDK_VERSION"
fi

# Verify installation
WASI_SDK_PATH=$(mise where "github:WebAssembly/wasi-sdk@$WASI_SDK_VERSION")
echo "WASI SDK at: $WASI_SDK_PATH"

if [ ! -f "$WASI_SDK_PATH/bin/clang" ]; then
    echo "ERROR: WASI SDK installation incomplete - clang not found"
    exit 1
fi
"""

[tasks.build-eryx-runtime]
description = "Build liberyx_runtime.so and runtime.wasm via eryx-runtime build.rs"
depends = ["ensure-wasi-sdk"]
run = """
# Get WASI SDK path and export it for build.rs (use explicit version)
export WASI_SDK_PATH=$(mise where github:WebAssembly/wasi-sdk@wasi-sdk-27)
echo "Using WASI SDK at: $WASI_SDK_PATH"
BUILD_ERYX_RUNTIME=1 cargo build --package eryx-runtime --release
"""
sources = ["crates/eryx-wasm-runtime/src/**/*.rs", "crates/eryx-wasm-runtime/clock_stubs.c", "crates/eryx-wasm-runtime/Cargo.toml", "crates/eryx-runtime/runtime.wit"]
outputs = ["crates/eryx-wasm-runtime/target/liberyx_runtime.so", "crates/eryx-runtime/runtime.wasm"]

[tasks.setup-eryx-runtime-tests]
description = "Extract Python stdlib for eryx-wasm-runtime tests"
dir = "crates/eryx-wasm-runtime"
run = """
mkdir -p tests/python-stdlib tests/site-packages
# Find the python-lib.tar.zst from componentize-py build output
PYTHON_LIB=$(find ../../target -name 'python-lib.tar.zst' -path '*/componentize-py-*/out/*' 2>/dev/null | head -1)
if [[ -z "$PYTHON_LIB" ]]; then
    echo "Error: python-lib.tar.zst not found. Run 'cargo build' first to build componentize-py."
    exit 1
fi
echo "Extracting $PYTHON_LIB"
tar -xf "$PYTHON_LIB" -C tests/python-stdlib
"""
outputs = ["tests/python-stdlib/encodings/__init__.py"]

[tasks.test-eryx-runtime]
description = "Run eryx-wasm-runtime integration tests"
depends = ["build-eryx-runtime", "setup-eryx-runtime-tests"]
run = "cargo test --package eryx-wasm-runtime --test runtime_test -- --nocapture"
